library HFBetaBlockerTherapyforLVSDFHIR version '0.0.010'

using QICore version '4.1.1'

include FHIRHelpers version '4.0.012' called FHIRHelpers
include SupplementalDataElementsQICore4 version '3.0.000' called SDE
include MATGlobalCommonFunctionsQICore4 version '7.0.000' called Global
include QICoreCommon version '1.0.000' called Common

codesystem "LOINC": 'http://loinc.org' 
codesystem "SNOMEDCT": 'http://snomed.info/sct' 

valueset "Allergy to Beta Blocker Therapy": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.1177' 
valueset "Arrhythmia": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.366' 
valueset "Asthma": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.362' 
valueset "Atrioventricular Block": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.367' 
valueset "Beta Blocker Therapy": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.1174' 
valueset "Beta Blocker Therapy for LVSD": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.1184' 
valueset "Beta Blocker Therapy Ingredient": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.1493' 
valueset "Bradycardia": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.412' 
valueset "Cardiac Pacer": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1178.53' 
valueset "Cardiac Pacer in Situ": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.368' 
valueset "Care Services in Long Term Residential Facility": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.464.1003.101.12.1014' 
valueset "Discharge Services Hospital Inpatient": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.464.1003.101.12.1007' 
valueset "Ejection Fraction": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.1134' 
valueset "Face-to-Face Interaction": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.464.1003.101.12.1048' 
valueset "Heart Failure": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.376' 
valueset "Heart Rate": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.1176' 
valueset "Heart Transplant": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1178.33' 
valueset "Heart Transplant Related Diagnoses": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1178.56' 
valueset "Home Healthcare Services": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.464.1003.101.12.1016' 
valueset "Hypotension": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.370' 
valueset "Intolerance to Beta Blocker Therapy": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.1178' 
valueset "Left Ventricular Assist Device Placement": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1178.61' 
valueset "Left Ventricular Assist Device Related Diagnoses": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1178.58' 
valueset "Medical Reason": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.1007' 
valueset "Moderate or Severe": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.1092' 
valueset "Moderate or Severe LVSD": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.1090' 
valueset "Nursing Facility Visit": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.464.1003.101.12.1012' 
valueset "Office Visit": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.464.1003.101.12.1001' 
valueset "Outpatient Consultation": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.464.1003.101.12.1008' 
valueset "Patient Provider Interaction": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.1012' 
valueset "Patient Reason": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.1008' 
valueset "System Reason": 'http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113883.3.526.3.1009' 

code "Birth date": '21112-8' from "LOINC" display 'Birth date'
code "Left ventricular systolic dysfunction (disorder)": '134401001' from "SNOMEDCT" display 'Left ventricular systolic dysfunction (disorder)'
code "Substance with beta adrenergic receptor antagonist mechanism of action (substance)": '373254001' from "SNOMEDCT" display 'Substance with beta adrenergic receptor antagonist mechanism of action (substance)'

parameter "Measurement Period" default Interval[@2022-01-01, @2022-12-31]

context Patient

define "SDE Ethnicity":
  SDE."SDE Ethnicity"

define "SDE Payer":
  SDE."SDE Payer"

define "SDE Race":
  SDE."SDE Race"

define "SDE Sex":
  SDE."SDE Sex"

define "Initial Population":
  AgeInYearsAt(date from start of "Measurement Period")>= 18
                and Count("Qualifying Encounter During Measurement Period")>= 2
                and exists( "Heart Failure Outpatient Encounter")

define "Denominator":
  "Initial Population"
              and exists "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD"

define "Denominator Exclusions":
  "Has Heart Transplant"
                    or "Has Heart Transplant Related Diagnosis"
                    or "Has Left Ventricular Assist Device Implanted"
                    or "Has Left Ventricular Assist Device Related Diagnosis"

define "Numerator":
  "Has Beta Blocker Therapy for LVSD Ordered"
                    or "Is Currently Taking Beta Blocker Therapy for LVSD"

define "Denominator Exceptions":
  "Has Consecutive Heart Rates Less than 50"
                    or "Has Medical or Patient Reason for Not Ordering Beta Blocker for LVSD"
                    or "Has Arrhythmia Diagnosis"
                    or "Has Hypotension Diagnosis"
                    or "Has Asthma Diagnosis"
                    or "Has Diagnosis of Allergy or Intolerance to Beta Blocker Therapy"
                    or "Has Bradycardia Diagnosis"
                    or "Has Allergy or Intolerance to Beta Blocker Therapy Ingredient"
                    or "Atrioventricular Block without Cardiac Pacer"

define "Atrioventricular Block without Cardiac Pacer":
  "Has Atrioventricular Block Diagnosis"
                    and not "Has Diagnosis of Cardiac Pacer in Situ"
                    and not "Has Cardiac Pacer Device Implanted"

define "Moderate or Severe LVSD Findings":
  ( ["Observation": "Ejection Fraction"] EjectionFraction
                      where EjectionFraction.value <= 40 '%'
                          and EjectionFraction.status in {'final', 'amended', 'corrected'}
                  )
                    union 
                        (
                            ["Condition": "Moderate or Severe LVSD"]
                              union ( ["Condition": "Left ventricular systolic dysfunction (disorder)"] LVSD
                                where LVSD.severity in "Moderate or Severe"
                            ) 
                        ) LVSD
                          where LVSD.isConfirmedActiveDiagnosis() 

define "Qualifying Encounter During Measurement Period":
  ( ["Encounter": "Care Services in Long Term Residential Facility"]
                    union ["Encounter": "Home Healthcare Services"]
                    union ["Encounter": "Nursing Facility Visit"]
                    union ["Encounter": "Office Visit"]
                    union ["Encounter": "Outpatient Consultation"]
                    union ["Encounter": "Patient Provider Interaction"] ) ValidEncounter
                    where ValidEncounter.period during "Measurement Period"
                      and ValidEncounter.isFinished()

define "Heart Failure Outpatient Encounter":
  ( ["Encounter": "Care Services in Long Term Residential Facility"]
                    union ["Encounter": "Home Healthcare Services"]
                    union ["Encounter": "Nursing Facility Visit"]
                    union ["Encounter": "Office Visit"]
                    union ["Encounter": "Outpatient Consultation"] ) QualifyingEncounter
                    with ["Condition": "Heart Failure"] HeartFailure
                     such that HeartFailure.toPrevalenceInterval() overlaps QualifyingEncounter.period  
        and HeartFailure.isConfirmedActiveDiagnosis()
    where QualifyingEncounter.period during "Measurement Period"
      and QualifyingEncounter.isFinished()


define "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD":
  "Heart Failure Outpatient Encounter" HFOutpatientEncounter
                    with "Moderate or Severe LVSD Observations" LVSDObservations
        such that LVSDObservations.effective.toInterval() starts before end of HFOutpatientEncounter.period )


define "Is Currently Taking Beta Blocker Therapy for LVSD":
  exists ( ["MedicationRequest": "Beta Blocker Therapy for LVSD"] ActiveBetaBlocker
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
                  such that exists(ActiveBetaBlocker.dosageInstruction.timing T
              where T.repeat.bounds.toInterval() overlaps after ModerateOrSevereLVSDHFOutpatientEncounter.period )
            where ActiveBetaBlocker.status in { 'active', 'completed', 'finished' }            
              )

define "Has Arrhythmia Diagnosis":
  exists ( ["Condition": "Arrhythmia"] Arrhythmia
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
                  such that Arrhythmia.toPrevalenceInterval() overlaps ModerateOrSevereLVSDHFOutpatientEncounter.period
            where Arrhythmia.isConfirmedActiveDiagnosis()
              )

define "Has Asthma Diagnosis":
  exists ( ["Condition": "Asthma"] Asthma
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter 
                  such that Asthma.toPrevalenceInterval() overlaps ModerateOrSevereLVSDHFOutpatientEncounter.period
            where Asthma.isConfirmedActiveDiagnosis()
             )

define "Has Atrioventricular Block Diagnosis":
  exists ( ["Condition": "Atrioventricular Block"] AtrioventricularBlock
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter 
                  such that AtrioventricularBlock.toPrevalenceInterval() overlaps ModerateOrSevereLVSDHFOutpatientEncounter.period
            where AtrioventricularBlock.isConfirmedActiveDiagnosis()
             )

define "Has Beta Blocker Therapy for LVSD Ordered":
  exists ( 
            ["MedicationRequest": "Beta Blocker Therapy for LVSD"] BetaBlockerOrdered
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
                  such that BetaBlockerOrdered.authoredOn during ModerateOrSevereLVSDHFOutpatientEncounter.period
              where BetaBlockerOrdered.status in {'active', 'completed'}
                  and BetaBlockerOrdered.intent = 'order'
             )

define "Has Bradycardia Diagnosis":
  exists ( ["Condition": "Bradycardia"] Bradycardia
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
              such that Bradycardia.toPrevalenceInterval() overlaps ModerateOrSevereLVSDHFOutpatientEncounter.period
            where Bradycardia.isConfirmedActiveDiagnosis()
             )

define "Has Diagnosis of Allergy or Intolerance to Beta Blocker Therapy":
  exists ( 
              ( ["Condition": "Allergy to Beta Blocker Therapy"]
                    union ["Condition": "Intolerance to Beta Blocker Therapy"] ) BetaBlockerAllergyOrIntoleranceDiagnosis
                  with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
                    such that BetaBlockerAllergyOrIntoleranceDiagnosis.toInterval() overlaps after ModerateOrSevereLVSDHFOutpatientEncounter.period              
                    where BetaBlockerAllergyOrIntoleranceDiagnosis.isConfirmedActiveDiagnosis()
             )

define "Has Diagnosis of Cardiac Pacer in Situ":
  exists ( ["Condition": "Cardiac Pacer in Situ"] CardiacPacerDiagnosis
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
                  such that CardiacPacerDiagnosis.toPrevalenceInterval() overlaps after ModerateOrSevereLVSDHFOutpatientEncounter.period
            where CardiacPacerDiagnosis.isConfirmedActiveDiagnosis()
             )

define "Has Diagnosis of Intolerance to Beta Blocker Therapy":
  exists ( ["Condition": "Intolerance to Beta Blocker Therapy"] BetaBlockerIntoleranceDiagnosis
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
                 such that BetaBlockerIntoleranceDiagnosis.toPrevalenceInterval() overlaps after ModerateOrSevereLVSDHFOutpatientEncounter.period
            where BetaBlockerIntoleranceDiagnosis.isConfirmedActiveDiagnosis()
             )

define "Has Heart Transplant":
  exists ( ["Procedure": "Heart Transplant"] HeartTransplant
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
                  such that HeartTransplant.performed.toInterval() starts before end of ModerateOrSevereLVSDHFOutpatientEncounter.period
            where HeartTransplant.status = 'completed'
             )

define "Has Heart Transplant Related Diagnosis":
  exists ( ["Condition": "Heart Transplant Related Diagnoses"] HeartTransplantCondition
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
                  such that HeartTransplantCondition.toInterval() starts before end of ModerateOrSevereLVSDHFOutpatientEncounter.period
            where HeartTransplantCondition.isConfirmedActiveDiagnosis()
             )

define "Has Hypotension Diagnosis":
  exists ( ["Condition": "Hypotension"] Hypotension
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
                  such that Hypotension.toPrevalenceInterval() overlaps after ModerateOrSevereLVSDHFOutpatientEncounter.period
            where Hypotension.isConfirmedActiveDiagnosis()
             )

define "Has Left Ventricular Assist Device Implanted":
  exists ( ["Procedure": "Left Ventricular Assist Device Placement"] LVADOutpatient
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
              such that LVADOutpatient.toPrevalenceInterval() starts before end of ModerateOrSevereLVSDHFOutpatientEncounter.period
            where LVADOutpatient.isConfirmedActiveDiagnosis()
             )

define "Has Left Ventricular Assist Device Related Diagnosis":
  exists ( ["Condition": "Left Ventricular Assist Device Related Diagnoses"] LVADCondition
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
              such that LVADCondition.toInterval() starts before end of ModerateOrSevereLVSDHFOutpatientEncounter.period
            where LVADCondition.isConfirmedActiveDiagnosis()
             )

define "Has Medical or Patient Reason for Not Ordering Beta Blocker for LVSD":
  exists ( ["MedicationRequest": "Beta Blocker Therapy for LVSD"] NoBetaBlockerOrdered
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
                  such that NoBetaBlockerOrdered.authoredOn during ModerateOrSevereLVSDHFOutpatientEncounter.period
              where NoBetaBlockerOrdered.status = 'completed' 
                  and NoBetaBlockerOrdered.doNotPerform is true 
                  and ( NoBetaBlockerOrdered.reasonCode in "Medical Reason"
                          or NoBetaBlockerOrdered.reasonCode in "Patient Reason")
             )

define "Has Allergy or Intolerance to Beta Blocker Therapy Ingredient":
  exists ( 
              ( ["AllergyIntolerance": "Beta Blocker Therapy Ingredient"]
                  union ["AllergyIntolerance": "Substance with beta adrenergic receptor antagonist mechanism of action (substance)"] ) BetaBlockerAllergyIntolerance
                  with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
                      such that BetaBlockerAllergyIntolerance.onset.toInterval() overlaps after ModerateOrSevereLVSDHFOutpatientEncounter.period
                      where BetaBlockerAllergyIntolerance.clinicalStatus ~ Common."allergy-active"
                and BetaBlockerAllergyIntolerance.verificationStatus ~ Common."confirmed"
             )

define "Has Cardiac Pacer Device Implanted":
  exists ( ["Procedure": "Cardiac Pacer"] ImplantedCardiacPacer
              with "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
                      such that ImplantedCardiacPacer.onset.toInterval() overlaps after ModerateOrSevereLVSDHFOutpatientEncounter.period)
              where ImplantedCardiacPacer.isConfirmedActiveDiagnosis()
             )

define "Has Consecutive Heart Rates Less than 50":
  exists ( from
              ["Observation": "Heart Rate"] HeartRate,
              "Heart Failure Outpatient Encounter with History of Moderate or Severe LVSD" ModerateOrSevereLVSDHFOutpatientEncounter
                  let PriorHeartRate: 
                      Last ( ["Observation": "Heart Rate"] MostRecentPriorHeartRate
                          where MostRecentPriorHeartRate.toInterval() overlaps after ModerateOrSevereLVSDHFOutpatientEncounter.period
                              and MostRecentPriorHeartRate.status in {'final', 'amended', 'corrected'}
                          sort by start of .toInterval() (effective)
                          )
                  where HeartRate.effective during ModerateOrSevereLVSDHFOutpatientEncounter.period
                      and HeartRate.status in {'final', 'amended', 'corrected'}
                      and HeartRate.value < 50 '{beats}/min'
                      and PriorHeartRate.value < 50 '{beats}/min'
              )
